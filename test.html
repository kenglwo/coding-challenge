<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Level 1</title>
    <!-- <script -->
    <!--   src="https://code.jquery.com/jquery&#45;3.5.1.min.js" -->
    <!--   integrity="sha256&#45;9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" -->
    <!--   crossorigin="anonymous" -->
    <!-- ></script> -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  </head>
  <body>
    <div id="heatmap1"></div>
    <script type="module">
      import { processData } from "./module.js";

      const dataPath = "./temperature_daily.csv";

      // set the dimensions and margins of the graph
      var margin = { top: 50, right: 30, bottom: 30, left: 80 },
        width = 950 - margin.left - margin.right,
        height = 650 - margin.top - margin.bottom;

      // append the svg object to the body of the page
      var svg = d3
        .select("#heatmap1")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      // Labels of row and columns
      const myGroups = [...Array(21).keys()].map((i) => i + 1997);
      const months = [
        "January",
        "February",
        "March",
        "April",
        "May",
        "June",
        "July",
        "August",
        "September",
        "October",
        "November",
        "December",
      ].reverse();

      function mapMonth(month) {
        return months[month - 1];
      }

      // Build X scales and axis:
      var x = d3.scaleBand().range([0, width]).domain(myGroups).padding(0.01);
      svg.append("g").call(d3.axisTop(x));

      // Build X scales and axis:
      var y = d3.scaleBand().range([height, 0]).domain(months).padding(0.01);
      svg.append("g").call(d3.axisLeft(y));

      let aggData = [];
      let allMaxMinTemperature = { max: [], min: [] };
      let yearMonthlyTemperature = {};
      for (let year = 1997; year <= 2017; year++) {
        for (let month = 1; month <= 12; month++) {
          const initialData = {
            year: year,
            month: month,
            max: 0,
            min: 0,
          };
          aggData.push(initialData);
          yearMonthlyTemperature[year] = yearMonthlyTemperature[year]
            ? yearMonthlyTemperature[year]
            : {};
          yearMonthlyTemperature[year][month] = yearMonthlyTemperature[year][
            month
          ]
            ? yearMonthlyTemperature[year][month]
            : { max: [], min: [] };
        }
      }

      d3.csv(dataPath, function (data) {
        for (let d of data) {
          const [year, month, day] = d.date.split("-");
          const newData = {
            year: Number(year),
            month: Number(month),
            day: day,
            max: Number(d.max_temperature),
            min: Number(d.min_temperature),
          };
          yearMonthlyTemperature[newData.year][newData.month]["max"].push(
            newData.max
          );
          yearMonthlyTemperature[newData.year][newData.month]["min"].push(
            newData.min
          );
          allMaxMinTemperature["max"].push(newData["max"]);
          allMaxMinTemperature["min"].push(newData["min"]);
        }

        // Build color scale
        const maxColor = d3
          .scaleLinear()
          .range(["#FFFEBB", "#8D0137"])
          .domain([
            Math.min(...allMaxMinTemperature["max"]),
            Math.max(...allMaxMinTemperature["max"]),
          ]);

        for (let item of aggData) {
          const year = item["year"];
          const month = item["month"];
          item["max"] = yearMonthlyTemperature[year][month]["max"];
          item["min"] = yearMonthlyTemperature[year][month]["min"];
        }

        // del empty item
        aggData = aggData.filter((item) => {
          return item["max"].length > 0 && item["min"].length > 0;
        });

        for (let item of aggData) {
          if (item["year"] == 2017) {
            console.log(item);
          }
        }

        svg
          .selectAll()
          .data(aggData)
          //.data(aggData, function (d) {
          //  return d.year + ":" + d.month;
          //})
          .enter()
          .append("rect")
          .attr("x", function (d) {
            return x(d.year);
          })
          .attr("y", function (d) {
            return height - height / 12 - y(mapMonth(d.month));
          })
          .attr("width", x.bandwidth())
          .attr("height", y.bandwidth())
          .style("fill", function (d) {
            const maxTemperature = Math.max(...d["max"]);
            return maxColor(maxTemperature);
          });
      });
    </script>
  </body>
</html>
