<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Level 3</title>
    <!-- <script -->
    <!--   src="https://code.jquery.com/jquery&#45;3.5.1.min.js" -->
    <!--   integrity="sha256&#45;9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" -->
    <!--   crossorigin="anonymous" -->
    <!-- ></script> -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
      crossorigin="anonymous"
    />
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <style>
      .links line {
        stroke: #999;
        stroke-opacity: 0.6;
      }

      .nodes circle {
        stroke: #fff;
        stroke-width: 1.5px;
      }
    </style>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  </head>
  <body>
		<div class="m-5">
			<svg class="m=5" width="960" height="600"></svg>
		</div>
    <script>
      const dataPath =
        "https://raw.githubusercontent.com/HKUST-VISLab/coding-challenge/master/HKUST_coauthor_graph.json";

      const width = 960;
      const height = 600;

      let svg = d3.select("svg").attr("width", width).attr("height", height);
      let color = d3.scaleOrdinal(d3.schemeCategory20);

      let simulation = d3
        .forceSimulation()
        .force(
          "link",
          d3.forceLink().id(function (d) {
            return d.id;
          })
        )
        .force("charge", d3.forceManyBody())
        .force("center", d3.forceCenter(width / 2, height / 2));

      d3.json(dataPath, function (error, graph) {
        if (error) throw error;

				const nodesOfCSE = graph.nodes.filter(node => node["dept"] == "CSE");
				const nodesOfCSEIds = nodesOfCSE.map(node => node["id"]);
				const edgesOfCSE = graph.edges.filter(edge => nodesOfCSEIds.includes(edge["source"]) && nodesOfCSEIds.includes(edge["target"]));
				console.log(edgesOfCSE);

        var link = svg
          .append("g")
          .attr("class", "edges")
          .selectAll("line")
          .data(edgesOfCSE)
          .enter()
          .append("line")
          .attr("stroke-width", function (d) {
            // return Math.sqrt(d.publications.length);
            return 0.5;
          })
					.attr("stroke", "#999");

        var node = svg
          .append("g")
          .attr("class", "nodes")
          .selectAll("g")
					.data(nodesOfCSE)
          .enter()
          .append("g");

        var circles = node
          .append("circle")
          .attr("r", 5)
          .attr("fill", function (d) {
            return color(d.id);
          })
          .call(
            d3
              .drag()
              .on("start", dragstarted)
              .on("drag", dragged)
              .on("end", dragended)
          );

        // var lables = node
          // .append("text")
          // .text(function (d) {
          //   return d.id;
          // })
          // .attr("x", 6)
          // .attr("y", 3);

        // node.append("title").text(function (d) {
        //   return d.id;
        // });

        simulation.nodes(graph.nodes).on("tick", ticked);

        simulation.force("link").links(graph.edges);

        function ticked() {
          link
            .attr("x1", function (d) {
              return d.source.x;
            })
            .attr("y1", function (d) {
              return d.source.y;
            })
            .attr("x2", function (d) {
              return d.target.x;
            })
            .attr("y2", function (d) {
              return d.target.y;
            });

          node.attr("transform", function (d) {
            return "translate(" + d.x + "," + d.y + ")";
          });
        }
      });

      function dragstarted(d) {
        if (!d3.event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }

      function dragged(d) {
        d.fx = d3.event.x;
        d.fy = d3.event.y;
      }

      function dragended(d) {
        if (!d3.event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }
    </script>
  </body>
</html>
